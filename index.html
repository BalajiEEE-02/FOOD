<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodCo Enterprise Suite v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --accent: #6366f1; --bg: #0f172a; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Roboto, sans-serif; }
        .sidebar { background: var(--bg); height: 100vh; width: 280px; transition: 0.3s; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 12px; color: #94a3b8; transition: 0.2s; cursor: pointer; }
        .nav-link:hover { background: #1e293b; color: white; }
        .active-nav { background: var(--accent) !important; color: white; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4); }
        input, select { background: #fff; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 14px; width: 100%; }
        .btn-primary { background: var(--accent); color: white; font-weight: 700; padding: 12px; border-radius: 10px; transition: 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body class="flex">

    <aside class="sidebar p-6 flex flex-col fixed left-0 top-0 shadow-2xl">
        <div class="mb-8 px-2">
            <h1 class="text-2xl font-black text-white tracking-tighter">FOODCO <span class="text-indigo-400">PRO</span></h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Management v5.0.2</p>
        </div>
        
        <nav class="flex-1 space-y-2 overflow-y-auto">
            <div onclick="showTab('dashboard')" id="nav-dashboard" class="nav-link active-nav"><i class="fas fa-th-large"></i> Dashboard</div>
            <div onclick="showTab('members')" id="nav-members" class="nav-link"><i class="fas fa-users-cog"></i> Master Members</div>
            <div onclick="showTab('monthly')" id="nav-monthly" class="nav-link"><i class="fas fa-calendar-alt"></i> Monthly Records</div>
            <div onclick="showTab('finance')" id="nav-finance" class="nav-link"><i class="fas fa-money-check-alt"></i> Finance Hub</div>
        </nav>

        <div class="pt-6 border-t border-slate-800">
            <div id="g-signin" class="bg-white/5 p-4 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/10 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-5">
                <span class="text-sm font-bold text-white">Google Sync</span>
            </div>
        </div>
    </aside>

    <main class="ml-[280px] flex-1 p-10">

        <section id="tab-dashboard" class="tab-content block space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">Executive Dashboard</h2>
                <div class="text-right">
                    <p id="curr-date" class="font-bold text-slate-400">--</p>
                    <p class="text-indigo-600 font-black">ACTIVE STATUS</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-xs font-bold text-slate-400 uppercase">Cash Account</p>
                    <p id="cash-balance" class="text-2xl font-black text-emerald-600">₹ 0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-xs font-bold text-slate-400 uppercase">GPay Account</p>
                    <p id="gpay-balance" class="text-2xl font-black text-blue-600">₹ 0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-xs font-bold text-slate-400 uppercase">Total Spent (Mat/Sal)</p>
                    <p id="total-spent" class="text-2xl font-black text-red-500">₹ 0</p>
                </div>
                <div class="bg-indigo-600 p-6 rounded-3xl text-white">
                    <p class="text-xs font-bold opacity-70 uppercase">Total Receivable</p>
                    <p id="total-receivable" class="text-2xl font-black">₹ 0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card p-8 rounded-[2rem]"><canvas id="collectionChart"></canvas></div>
                <div class="glass-card p-8 rounded-[2rem]"><canvas id="deptChart"></canvas></div>
            </div>
        </section>

        <section id="tab-members" class="tab-content hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black">Member Directory</h2>
                <button onclick="openModal('member-modal')" class="btn-primary px-8">+ Add Member</button>
            </div>

            <div class="glass-card rounded-[2rem] overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-slate-100/50 text-slate-500 text-[11px] uppercase tracking-widest font-bold">
                        <tr>
                            <th class="p-5">Student Details</th>
                            <th class="p-5">Group/Dept</th>
                            <th class="p-5">Contact</th>
                            <th class="p-5">Joined</th>
                            <th class="p-5 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="master-list-tbody"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-monthly" class="tab-content hidden space-y-6">
            <div class="flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border">
                <div>
                    <h2 class="text-2xl font-black">Attendance & Declarations</h2>
                    <select id="month-picker" onchange="loadMonthlyData()" class="mt-2 border-none font-bold text-indigo-600"></select>
                </div>
                <button onclick="migrateToMonthly()" class="bg-indigo-100 text-indigo-600 px-6 py-2 rounded-xl font-bold hover:bg-indigo-600 hover:text-white transition">
                    Sync from Master
                </button>
            </div>

            <div class="glass-card rounded-[2rem] overflow-hidden shadow-sm">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4">Name</th>
                            <th class="p-4">Material Decl.</th>
                            <th class="p-4">Salary Decl.</th>
                            <th class="p-4">Absents</th>
                            <th class="p-4 text-center">Net Amount</th>
                            <th class="p-4">Payment</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-list-tbody"></tbody>
                </table>
            </div>
        </section>

    </main>

    <div id="member-modal" class="fixed inset-0 bg-slate-900/40 hidden z-[100] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-black mb-6">Register Student</h3>
            <div class="space-y-4">
                <input type="text" id="m-name" placeholder="Full Name">
                <select id="m-dept">
                    <option>AIDS</option><option>AIML</option><option>CSE</option><option>IT</option>
                    <option>ECE</option><option>EEE</option><option>CIVIL</option><option>MECH</option>
                    <option>CHEMICAL</option><option>CCE</option><option>CSBS</option>
                </select>
                <select id="m-year">
                    <option>1st Year</option><option>2nd Year</option><option>3rd Year</option><option>Final Year</option>
                </select>
                <input type="text" id="m-phone" placeholder="Mobile Number">
                <button onclick="saveNewMember()" class="w-full btn-primary mt-4">Save To Database</button>
                <button onclick="closeModal('member-modal')" class="w-full text-slate-400 font-bold">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let db;
        const req = indexedDB.open("FoodCo_V5_Core", 1);

        req.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("master", { keyPath: "name" });
            db.createObjectStore("monthly", { keyPath: "id" });
            db.createObjectStore("settings", { keyPath: "key" });
        };

        req.onsuccess = (e) => { db = e.target.result; init(); };

        function init() {
            document.getElementById('curr-date').innerText = new Date().toDateString();
            populateMonthPicker();
            renderDashboard();
            loadMasterMembers();
        }

        // --- NAVIGATION ---
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active-nav'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('nav-' + id).classList.add('active-nav');
            if(id === 'monthly') loadMonthlyData();
            if(id === 'members') loadMasterMembers();
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- CORE LOGIC: MASTER MEMBERS ---
        function saveNewMember() {
            const data = {
                name: document.getElementById('m-name').value,
                dept: document.getElementById('m-dept').value,
                year: document.getElementById('m-year').value,
                phone: document.getElementById('m-phone').value,
                joinDate: new Date().toLocaleDateString()
            };
            if(!data.name) return;
            const tx = db.transaction("master", "readwrite");
            tx.objectStore("master").add(data);
            tx.oncomplete = () => { closeModal('member-modal'); loadMasterMembers(); };
        }

        function loadMasterMembers() {
            const tbody = document.getElementById('master-list-tbody');
            tbody.innerHTML = "";
            const tx = db.transaction("master", "readonly");
            tx.objectStore("master").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const m = cursor.value;
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50 transition">
                            <td class="p-5 font-bold">${m.name}</td>
                            <td class="p-5"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs">${m.dept} | ${m.year}</span></td>
                            <td class="p-5">
                                <span class="cursor-pointer text-blue-500" onclick="navigator.clipboard.writeText('${m.phone}'); alert('Copied!')">
                                    <i class="fas fa-copy mr-2"></i>${m.phone}
                                </span>
                            </td>
                            <td class="p-5 text-slate-400 text-xs">${m.joinDate}</td>
                            <td class="p-5 text-right">
                                <button onclick="deleteMember('${m.name}')" class="text-red-300 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    cursor.continue();
                }
            };
        }

        function deleteMember(name) {
            if(!confirm("Are you sure?")) return;
            const tx = db.transaction("master", "readwrite");
            tx.objectStore("master").delete(name);
            tx.oncomplete = () => loadMasterMembers();
        }

        // --- CORE LOGIC: MONTHLY ENGINE ---
        function migrateToMonthly() {
            const month = document.getElementById('month-picker').value;
            const txM = db.transaction("master", "readonly");
            txM.objectStore("master").getAll().onsuccess = (e) => {
                const students = e.target.result;
                const txMonthly = db.transaction("monthly", "readwrite");
                const store = txMonthly.objectStore("monthly");
                students.forEach(s => {
                    store.put({
                        id: `${month}_${s.name}`,
                        name: s.name,
                        month: month,
                        matDecl: 0, salDecl: 0, absents: 0,
                        paid: 0, method: 'Cash', date: ''
                    });
                });
                txMonthly.oncomplete = () => { alert(`Synced for ${month}`); loadMonthlyData(); };
            };
        }

        function loadMonthlyData() {
            const month = document.getElementById('month-picker').value;
            const tbody = document.getElementById('monthly-list-tbody');
            tbody.innerHTML = "";
            const tx = db.transaction("monthly", "readonly");
            tx.objectStore("monthly").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const r = cursor.value;
                    if(r.id.startsWith(month)) {
                        const net = (Number(r.matDecl) + Number(r.salDecl)) - (r.absents * 50); // Math: 50 per absent day
                        tbody.innerHTML += `
                            <tr class="border-b">
                                <td class="p-4 font-bold text-slate-600">${r.name}</td>
                                <td class="p-4"><input type="number" onchange="updateMonthly('${r.id}', 'matDecl', this.value)" class="w-20" value="${r.matDecl}"></td>
                                <td class="p-4"><input type="number" onchange="updateMonthly('${r.id}', 'salDecl', this.value)" class="w-20" value="${r.salDecl}"></td>
                                <td class="p-4"><input type="number" onchange="updateMonthly('${r.id}', 'absents', this.value)" class="w-16" value="${r.absents}"></td>
                                <td class="p-4 text-center font-black text-indigo-600">₹${net}</td>
                                <td class="p-4">
                                    <div class="flex gap-2">
                                        <input type="number" onchange="updateMonthly('${r.id}', 'paid', this.value)" class="w-24" placeholder="Paid" value="${r.paid}">
                                        <select onchange="updateMonthly('${r.id}', 'method', this.value)" class="w-24">
                                            <option ${r.method=='Cash'?'selected':''}>Cash</option>
                                            <option ${r.method=='GPay'?'selected':''}>GPay</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    cursor.continue();
                }
                renderDashboard();
            };
        }

        function updateMonthly(id, field, value) {
            const tx = db.transaction("monthly", "readwrite");
            const store = tx.objectStore("monthly");
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                data[field] = (field === 'method') ? value : Number(value);
                store.put(data);
                renderDashboard();
            };
        }

        // --- DASHBOARD CHARTS & TOTALS ---
        function renderDashboard() {
            let cash = 0; let gpay = 0; let receivable = 0;
            const tx = db.transaction("monthly", "readonly");
            tx.objectStore("monthly").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const r = cursor.value;
                    const net = (r.matDecl + r.salDecl) - (r.absents * 50);
                    receivable += (net - r.paid);
                    if(r.method === 'Cash') cash += r.paid;
                    else gpay += r.paid;
                    cursor.continue();
                } else {
                    document.getElementById('cash-balance').innerText = `₹ ${cash}`;
                    document.getElementById('gpay-balance').innerText = `₹ ${gpay}`;
                    document.getElementById('total-receivable').innerText = `₹ ${receivable}`;
                }
            };
        }

        function populateMonthPicker() {
            const picker = document.getElementById('month-picker');
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            const currentYear = new Date().getFullYear();
            months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = `${m}_${currentYear}`;
                opt.innerText = `${m} ${currentYear}`;
                picker.appendChild(opt);
            });
            picker.value = `${months[new Date().getMonth()]}_${currentYear}`;
        }

        // --- VISUAL CHARTS ---
        window.onload = () => {
            const ctx1 = document.getElementById('collectionChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr'],
                    datasets: [{ label: 'Cash Flow', data: [12000, 19000, 15000, 22000], backgroundColor: '#6366f1' }]
                },
                options: { plugins: { title: { display: true, text: 'Company Collection Trend' } } }
            });
        };
    </script>
</body>
</html>
